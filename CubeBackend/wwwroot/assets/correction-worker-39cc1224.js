(function(){"use strict";function q(e){if(e==null||e==null)throw new Error("Value is not defined")}function R(e){return q(e),e}function F(){return new Worker("/assets/avg-color-worker-301cf04a.js")}const L=Array.from({length:3},e=>new F),b=10;let M,l,D=0,o=0,h=0,C=.125;function v(e){return e.reduce((t,a)=>t+a,0)/e.length*e.length}function I(e,t,a,i){let c,p,f;if(i){const s=e.map(r=>r*i[0]),d=t.map(r=>r*i[1]),u=a.map(r=>r*i[2]);c=v(s),p=v(d),f=v(u)}else c=v(e),p=v(t),f=v(a);return Math.abs(c-p)+Math.abs(c-f)+Math.abs(p-f)}function E(e){const t=(e[0]+e[1]+e[2])/3;return[t/e[0],t/e[1],t/e[2]]}function S(e){const t=Math.max(e[0],e[1],e[2]);return[t/e[0],t/e[1],t/e[2]]}function W(e,t){e[0]=Math.pow(e[0],t||C),e[1]=Math.pow(e[1],t||C),e[2]=Math.pow(e[2],t||C);const a=(e[0]+e[1]+e[2])/3;return[a/e[0],a/e[1],a/e[2]]}function V(e){const t=e.bitmap;l.drawImage(t,0,0);const a=e.selectedVideo;if(a!="normal"){const i=l.getImageData(0,0,o,h).data,c=new Uint8ClampedArray(D*3);for(let s=0;s<D;s++)c[s*3]=i[s*4],c[s*3+1]=i[s*4+1],c[s*3+2]=i[s*4+2];const p=[],f=[0,0,0];for(let s=0;s<3;s++){const d=s,u=R(L[s]);p.push(new Promise(r=>{u.addEventListener("message",m=>{f[d]=m.data,r(m.data)},{once:!0});const w={size:D,array:c,color:d};u.postMessage(w)}))}Promise.all(p).then(async s=>{if(a=="auto-detect"){const d=E(f),u=S(f),r=[];for(let n=1;n<=3;n++)r.push(W(f,1/Math.pow(2,n)));const w=new Array,m=new Array,x=new Array;for(let n=h/2-b;n<h/2+b;n++)for(let g=o/2-b;g<o/2+b;g++)w.push(c[(n*o+g)*3]),m.push(c[(n*o+g)*3+1]),x.push(c[(n*o+g)*3+2]),i[(n*o+g)*4]=255,i[(n*o+g)*4+1]=0,i[(n*o+g)*4+2]=255;const _=new ImageData(i,t.width,t.height);l.drawImage(await createImageBitmap(_),0,0);const z=I(w,m,x),B=I(w,m,x,d),j=I(w,m,x,u),A=[];for(let n=0;n<3;n++)A.push(I(w,m,x,r[n]));const k=Math.min(z,B,j,...A);let y="normal";if(k==B)y="avg-corrected";else if(k==j)y="max-corrected";else if(A.includes(k)){y="p-norm-corrected";for(let n=0;n<3;n++)if(A[n]==k){const g=Math.pow(2,n+1);y+=`|${g}`,C=1/g}}postMessage(y)}else{let d=[0,0,0];a=="avg-corrected"?d=E(f):a=="max-corrected"?d=S(f):a=="p-norm-corrected"&&(d=W(f));for(let r=0;r<D;r++)i[r*4]=Math.round(c[r*3]*d[0]),i[r*4+1]=Math.round(c[r*3+1]*d[1]),i[r*4+2]=Math.round(c[r*3+2]*d[2]);const u=new ImageData(i,t.width,t.height);M.drawImage(await createImageBitmap(u),0,0)}})}}self.addEventListener("message",e=>{const t=e.data;if(typeof t=="string"){let a;t=="normal"?a=l.getImageData(0,0,o,h):a=M.getImageData(0,0,o,h),postMessage(a.data,[a.data.buffer])}else if(typeof t=="number")C=1/t;else if("bitmap"in t)V(e.data),postMessage(1);else{const a=t;M=R(a.correctedCanvas.getContext("2d",{willReadFrequently:!0})),l=R(a.normalCanvas.getContext("2d",{willReadFrequently:!0})),o=a.width,h=a.height,D=o*h,l.canvas.width=o,l.canvas.height=h,M.canvas.width=o,M.canvas.height=h}})})();
